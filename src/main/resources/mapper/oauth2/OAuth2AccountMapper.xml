<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spacecore.mapper.oauth2.OAuth2AccountMapper">

    <!-- ✅ ResultMap -->
    <resultMap id="OAuth2AccountResultMap" type="com.spacecore.domain.oauth2.OAuth2Account">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="provider" column="provider"/>
        <result property="providerId" column="provider_id"/>
        <result property="accessToken" column="access_token"/>
        <result property="refreshToken" column="refresh_token"/>
        <result property="tokenExpiresAt" column="token_expires_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- ✅ 신규 INSERT -->
    <insert id="insert" parameterType="com.spacecore.domain.oauth2.OAuth2Account">
        <selectKey keyProperty="id" resultType="long" order="BEFORE">
            SELECT seq_oauth2_account.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO oauth2_account (
        id, user_id, provider, provider_id,
        access_token, refresh_token,
        token_expires_at, created_at, updated_at
        ) VALUES (
        #{id},
        #{userId},
        #{provider},
        #{providerId},
        #{accessToken, jdbcType=VARCHAR},
        #{refreshToken, jdbcType=VARCHAR},
        #{tokenExpiresAt, jdbcType=TIMESTAMP},
        SYSTIMESTAMP, SYSTIMESTAMP
        )
    </insert>

    <!-- ✅ userId 기준 조회 -->
    <select id="findByUserId" resultMap="OAuth2AccountResultMap">
        SELECT *
        FROM oauth2_account
        WHERE user_id = #{userId}
    </select>

    <!-- ✅ Access + Refresh Token 갱신 (null 값은 무시) -->
    <update id="updateTokens">
        UPDATE oauth2_account
        <set>
            <if test="accessToken != null">
                access_token = #{accessToken, jdbcType=VARCHAR},
            </if>
            <if test="refreshToken != null">
                refresh_token = #{refreshToken, jdbcType=VARCHAR},
            </if>
            <if test="expiresAt != null">
                token_expires_at = #{expiresAt, jdbcType=TIMESTAMP},
            </if>
            updated_at = SYSTIMESTAMP
        </set>
        WHERE user_id = #{userId}
    </update>

    <!-- ✅ AccessToken만 갱신 -->
    <update id="updateAccessTokenOnly">
        UPDATE oauth2_account
        SET
            access_token = #{accessToken, jdbcType=VARCHAR},
            token_expires_at = #{tokenExpiresAt, jdbcType=TIMESTAMP},
            updated_at = SYSTIMESTAMP
        WHERE user_id = #{userId}
    </update>

    <!-- ✅ 존재 여부 확인 -->
    <select id="existsByUserId" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM oauth2_account
        WHERE user_id = #{userId}
    </select>

    <!-- ✅ 삭제 -->
    <delete id="deleteByUserId">
        DELETE FROM oauth2_account
        WHERE user_id = #{userId}
    </delete>

</mapper>