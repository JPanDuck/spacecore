<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spacecore.mapper.reservation.ReservationMapper">

    <resultMap id="ReservationMap" type="com.spacecore.domain.reservation.Reservation">
        <id     property="id"       column="id"/>
        <result property="userId"   column="user_id"/>
        <result property="roomId"   column="room_id"/>
        <result property="reservantName" column="reservant_name"/>
        <result property="startAt"  column="start_at"/>
        <result property="endAt"    column="end_at"/>
        <result property="unit"     column="unit"/>
        <result property="status"   column="status"/>
        <result property="amount"   column="amount"/>
        <result property="memo"     column="memo"/>
        <result property="createdAt" column="created_at"/>
        <result property="userName" column="user_name"/>
        <result property="roomName" column="room_name"/>
    </resultMap>


    <!-- 전체 목록 조회 -->
    <select id="findAll" resultMap="ReservationMap">
        SELECT r.id,
               r.user_id,
               r.room_id,
               r.start_at,
               r.end_at,
               r.unit,
               r.status,
               r.amount,
               r.memo,
               r.created_at,
               r.reservant_name AS reservant_name,
               u.name AS user_name,
               rm.name AS room_name
               FROM reservations r
                 LEFT JOIN users u ON r.user_id = u.id
                 LEFT JOIN rooms rm ON r.room_id = rm.id
        ORDER BY r.created_at DESC
    </select>

    <!-- 내 예약 목록 -->
    <select id="findByUserId" parameterType="long" resultMap="ReservationMap">
        SELECT r.id,
               r.user_id,
               r.room_id,
               r.start_at,
               r.end_at,
               r.unit,
               r.status,
               r.amount,
               r.memo,
               r.created_at,
               r.reservant_name AS reservant_name,
               u.name AS user_name,
               rm.name AS room_name
        FROM reservations r
                 LEFT JOIN users u ON r.user_id = u.id
                 LEFT JOIN rooms rm ON r.room_id = rm.id
        WHERE r.user_id = #{userId}
        ORDER BY r.created_at DESC
    </select>

    <!-- 단건 조회 (PK) -->
    <select id="findById" parameterType="long" resultMap="ReservationMap">
        SELECT r.id,
               r.user_id,
               r.room_id,
               r.reservant_name,
               r.start_at,
               r.end_at,
               r.unit,
               r.status,
               r.amount,
               r.memo,
               r.created_at,
               u.name AS user_name,
               rm.name AS room_name
        FROM reservations r
                 LEFT JOIN users u ON r.user_id = u.id
                 LEFT JOIN rooms rm ON r.room_id = rm.id
        WHERE r.id = #{id}
    </select>

    <!-- 예약 생성 -->
    <insert id="insert" parameterType="com.spacecore.domain.reservation.Reservation">
        <selectKey keyProperty="id" resultType="long" order="BEFORE">
            SELECT seq_reservations.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO reservations (id, user_id, room_id, start_at,
        end_at, unit, amount, status, memo, reservant_name, created_at)
        VALUES (#{id}, #{userId}, #{roomId}, #{startAt}, #{endAt}, #{unit}, #{amount},
        #{status}, #{memo}, #{reservantName}, SYSTIMESTAMP)
    </insert>

    <!-- 예약 수정 -->
<!--    <update id="update" parameterType="com.spacecore.domain.reservation.Reservation">-->
<!--        UPDATE reservations-->
<!--        SET user_id  = #{userId},-->
<!--            room_id  = #{roomId},-->
<!--            start_at = #{startAt},-->
<!--            end_at   = #{endAt},-->
<!--            unit     = #{unit},-->
<!--            amount   = #{amount},-->
<!--            memo     = #{memo}-->
<!--        WHERE id = #{id}-->
<!--    </update>-->

    <!-- 예약 취소 -->
    <!-- 예약 상태 변경 (확정/취소/만료 등)-->
    <update id="updateStatus">
        UPDATE reservations
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 시간 범위의 예약 대기 상태 예약 ID 목록 조회 -->
    <select id="findAwaitingReservationIds" resultType="long">
        SELECT id
        FROM reservations
        WHERE room_id = #{roomId}
          AND status = 'AWAITING_PAYMENT'
          AND start_at &lt; #{endAt}
          AND end_at &gt; #{startAt}
    </select>


</mapper>